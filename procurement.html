<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFDO จัดซื้อจัดจ้าง</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" type="image/png" href="images/logorfdo.png">

    <style>
        /* === Theme Colors === */
        :root {
            --primary-color: #339999;
            --primary-dark: #206b6b;
            --primary-light: #e6f7f7;
            --text-color: #333;
            --text-muted: #666;
            --bg-color: #f8fcfc;
            --white: #ffffff;
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px rgba(0,0,0,0.08);
            --radius: 12px;
        }

        /* === General Styles === */
        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: "Prompt", sans-serif;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        img {
            user-select: none; -webkit-user-select: none;
            pointer-events: none; -webkit-user-drag: none;
        }
        
        /* เพิ่มความสำคัญให้ element ที่ต้องคลิกได้ */
        a, button, .dropdown:hover > a, .quick-links li a, .menu-item, .pdf-link { 
            pointer-events: auto !important; cursor: pointer; 
        }

        /* === Header Section === */
        .head-section {
            position: relative;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('images/head.jpg') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            padding: 60px 5%;
            min-height: 250px;
            gap: 20px;
            color: var(--white);
        }
        .head-section img#logo { 
            width: 100px; height: auto; 
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
        }
        .head-text-container { display: flex; flex-direction: column; }
        .head-text { 
            font-size: 48px; font-weight: 700; line-height: 1.2; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .sub-text { font-size: 20px; font-weight: 400; opacity: 0.9; }

        /* === Navigation === */
        nav {
            background: var(--primary-color);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        nav ul {
            display: flex;
            justify-content: center;
            gap: 20px; 
            list-style: none;
            margin: 0;
            padding: 5px 0;
            flex-wrap: wrap;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        nav ul li { position: relative; }

        nav ul li a {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px; 
            font-weight: 500;
            padding: 8px 14px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        nav ul li a:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            transform: translateY(-1px);
        }

        .home-icon { background: rgba(255,255,255,0.2) !important; padding: 8px 12px !important; }
        .home-icon svg { fill: white; width: 22px; height: 22px; }
        .home-icon:hover { background: rgba(255,255,255,0.4) !important; }

        /* Dropdown & Submenu Styles */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-width: 270px;
            padding: 8px 0;
            z-index: 1001;
            opacity: 0;
            transition: all 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
            margin-top: 10px;
        }
        .dropdown-menu::before {
            content: ""; position: absolute; top: -10px; left: 0; width: 100%; height: 10px; background: transparent;
        }
        .dropdown:hover > .dropdown-menu { display: block; opacity: 1; animation: fadeIn 0.2s ease-out forwards; }
        .dropdown-menu li { position: relative; }
        .dropdown-menu li a { 
            color: var(--text-color); padding: 12px 20px; border-radius: 0; 
            display: flex; justify-content: space-between; font-size: 16px; font-weight: 500;
        }
        .dropdown-menu li a:hover { background: var(--primary-light); color: var(--primary-dark); padding-left: 25px; }

        .submenu {
            display: none; position: absolute; left: 100%; top: -5px; margin-left: 10px;
            background: var(--white); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-width: 290px; padding: 8px 0; border: 1px solid rgba(0,0,0,0.05);
        }
        .submenu::after { content: ""; position: absolute; top: 0; left: -15px; width: 20px; height: 100%; background: transparent; }
        .nested-dropdown:hover > .submenu { display: block; animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === Content Layout === */
        main.content-container { 
            flex-grow: 1; 
            width: 100%;
            max-width: 1100px;
            margin: 40px auto; 
            padding: 40px; 
            background: var(--white); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-md); 
            min-height: 500px; 
            box-sizing: border-box;
        }

        .page-title { 
            font-size: 32px; 
            font-weight: 700;
            color: var(--primary-dark); 
            text-align: left;
            margin-top: 0;
            margin-bottom: 30px;
            border-left: 6px solid var(--primary-color);
            padding-left: 15px;
            line-height: 1.2;
        }

        /* === Custom Tabs for Procurement === */
        .procurement-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .tab-btn {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 30px;
            font-family: "Prompt", sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(51, 153, 153, 0.3);
        }

        /* === Table Styles === */
        .table-responsive {
            overflow-x: auto;
        }

        .doc-table { 
            width:100%; 
            border-collapse: separate; 
            border-spacing: 0;
            margin-top:10px; 
            table-layout: fixed; 
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        .doc-table th, .doc-table td { 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            text-align: left; 
            vertical-align: top; 
            font-size: 15px;
            position: relative; /* เพิ่มเพื่อให้ z-index ทำงาน */
            z-index: 1;
        }
        
        .doc-table th:nth-child(1), .doc-table td:nth-child(1) { width: 65%; word-wrap: break-word; }
        .doc-table th:nth-child(2), .doc-table td:nth-child(2) { width: 20%; }
        .doc-table th:nth-child(3), .doc-table td:nth-child(3) { width: 15%; text-align: center; }
        
        .doc-table th { 
            background: var(--primary-color); 
            color: #fff; 
            font-weight: 500; 
            border: none;
        }
        .doc-table tr:hover td { background-color: #fafafa; }

        /* === PDF Button Style Updated === */
        .pdf-link { 
            color: var(--primary-color);
            text-decoration: none; 
            font-weight: 600; 
            border: 1px solid var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            transition: 0.2s;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            /* แก้ไขให้กดได้แน่นอน */
            cursor: pointer !important;
            position: relative;
            z-index: 10;
        }
        .pdf-link i { font-size: 14px; pointer-events: none; } /* ป้องกันไอคอนบังการคลิก */
        
        .pdf-link:hover { 
            background: var(--primary-color);
            color: white; 
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ปุ่มสำหรับกรณีไม่มีไฟล์ */
        .pdf-link.no-file {
            background-color: #f5f5f5;
            border-color: #ddd;
            color: #999;
            cursor: default !important;
        }
        .pdf-link.no-file:hover {
            background-color: #f5f5f5;
            color: #999;
            transform: none;
            box-shadow: none;
        }

        /* === View All Button Style === */
        .view-all-container {
            text-align: right;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .view-all-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
        }
        .view-all-link:hover {
            color: var(--primary-color);
            transform: translateX(5px);
        }
        .view-all-link i { font-size: 12px; }

        /* Badge NEW */
        .new-badge { 
            display: inline-block; 
            background-color: #e74c3c; 
            color: white; 
            font-size: 10px; 
            font-weight: 700; 
            padding: 3px 6px; 
            border-radius: 4px; 
            margin-left: 8px; 
            vertical-align: middle; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Loading & Error */
        #loading-indicator { text-align: center; padding: 40px; color: var(--text-muted); display: none; }
        .error-message { color: red; text-align: center; padding: 20px; }
        .no-data { text-align: center; padding: 30px; color: var(--text-muted); font-style: italic; }

        /* Footer */
        footer { 
            text-align: center; 
            padding: 15px 20px; 
            background: var(--primary-color); 
            color: rgba(255,255,255,0.8); 
            font-size: 14px; 
            margin-top: auto; 
        }

        /* Responsive */
        @media (max-width: 860px) { 
            .head-section img#logo { width: 80px; } 
            .head-text { font-size: 28px; } 
            main.content-container { padding: 20px; margin: 20px auto; width: 95%; }
            .doc-table th, .doc-table td { padding: 10px; font-size: 14px; }
            .page-title { font-size: 26px; }
            .procurement-tabs { justify-content: center; }
        }
        @media (max-width: 600px) { 
            .head-section { flex-direction: column; text-align: center; padding: 40px 5%; } 
            .head-text { font-size: 24px; } 
            nav { padding: 5px 0; }
            nav ul { justify-content: center; gap: 5px; }
            nav ul li a { padding: 6px 12px; font-size: 13px; }
            .submenu { position: static; box-shadow: none; margin-left: 20px; border-left: 2px solid #eee; min-width: auto; }
            
            .doc-table th:nth-child(2), .doc-table td:nth-child(2) { display: none; }
            .doc-table th:nth-child(1), .doc-table td:nth-child(1) { width: 70%; }
            .doc-table th:nth-child(3), .doc-table td:nth-child(3) { width: 30%; }
            .tab-btn { flex: 1 1 45%; text-align: center; font-size: 13px; padding: 8px; }
        }
    </style>
</head>
<body>

    <div class="head-section">
        <img id="logo" src="images/logo.png" alt="logo" />
        <div class="head-text-container">
            <div class="head-text">ส่วนอำนวยการ</div>
            <div class="sub-text">สำนักวิจัยและพัฒนาการป่าไม้</div>
        </div>
    </div>

    <nav>
        <ul>
            <li><a href="index.html" class="home-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6h-6v6H4a1 1 0 0 1-1-1V10.5z"/></svg></a></li>
            
            <li class="dropdown">
                <a href="#">เกี่ยวกับเรา ▾</a>
                <ul class="dropdown-menu">
                    <li><a href="Structure.html">โครงสร้างส่วนอำนวยการ</a></li> 
                    <li class="nested-dropdown">
                        <a href="#">ฝ่ายภายในส่วนอำนวยการ ▸</a>
                        <ul class="submenu">
                            <li><a href="Adminrfdo.html">ฝ่ายธุรการ</a></li> 
                            <li><a href="HRrfdo.html">ฝ่ายการเจ้าหน้าที่</a></li>
                            <li><a href="FArfdo.html">ฝ่ายการเงิน และบัญชี</a></li>
                            <li><a href="PDrfdo.html">ฝ่ายการพัสดุ</a></li>
                            <li><a href="Planrfdo.html">ฝ่ายแผนและติดตามประเมินผล</a></li>
                            <li><a href="Researchrfdo.html">ฝ่ายพัฒนาและประสานงานวิจัยป่าไม้</a></li>
                        </ul>
                    </li>
                </ul>
            </li>

            <li class="dropdown">
                <a href="#">บริการสำหรับเจ้าหน้าที่ ▾</a>
                <ul class="dropdown-menu">
                    <li><a href="https://edoc.forest.go.th/SARABAN/login.html" target="_blank">ระบบสารบรรณอิเล็กทรอนิกส์</a></li>
                    <li><a href="https://itservice.forest.go.th/meeting/pages/?menu=home" target="_blank">ระบบจองห้องประชุม</a></li>
                    <li><a href="https://www.forest.go.th/product/th/zoom/" target="_blank">ระบบจองห้องประชุมออนไลน์</a></li>
                </ul>
            </li>

            <li class="dropdown">
                <a href="#">คำสั่ง/ประกาศ ▾</a>
                <ul class="dropdown-menu">
                    <li><a href="command.html">คำสั่ง</a></li>
                    <li><a href="announce.html">ประกาศ</a></li>
                </ul>
            </li>

            <li class="dropdown">
                <a href="#">ข่าวสาร ▾</a>
                <ul class="dropdown-menu">
                    <li class="nested-dropdown">
                        <a href="#">จัดซื้อจัดจ้าง ▸</a>
                        <ul class="submenu">
                            <li><a href="procurement_plan.html">แผนการจัดซื้อจัดจ้าง</a></li>
                            <li><a href="procurement_draft.html">ประกาศร่างขอบเขตของงานฯ</a></li>
                            <li><a href="procurement_announce.html">ประกาศจัดซื้อจัดจ้าง</a></li>
                            <li><a href="procurement_winner.html">ประกาศผู้ชนะการเสนอราคา</a></li>
                        </ul>
                    </li>
                    <li class="nested-dropdown">
                        <a href="#">ระบบหนังสือเวียนกรมป่าไม้ ▸</a>
                        <ul class="submenu">
                            <li><a href="https://edoc.forest.go.th/doccir/docindex.html" target="_blank">หนังสือเวียนกรมป่าไม้</a></li>
                            <li><a href="edocs.html">หนังสือเวียน สวพ.</a></li>
                        </ul>
                    </li>
                </ul>
            </li>

            <li class="dropdown">
                <a href="#">ระเบียบ ▾</a>
                <ul class="dropdown-menu">
                    <li><a href="procurement_regulations.html">ระเบียบเกี่ยวกับการพัสดุ</a></li>
                    <li><a href="official_co.html">ระเบียบการจัดทำหนังสือราชการ</a></li>
                </ul>
            </li>

            <li><a href="https://forprod.forest.go.th/forprod/forprod2017/form/default.html" target="_blank">แบบฟอร์ม</a></li>
            <li><a href="contact.html">ติดต่อ</a></li>
        </ul>
    </nav>

    <main class="content-container">
        <h2 class="page-title">ข่าวสารการจัดซื้อจัดจ้าง</h2>

        <div class="procurement-tabs">
            <button class="tab-btn active" id="btn-plan" onclick="loadTable('plan')">แผนการจัดซื้อจัดจ้าง</button>
            <button class="tab-btn" id="btn-draft" onclick="loadTable('draft')">ร่างขอบเขตของงาน (TOR)</button>
            <button class="tab-btn" id="btn-announce" onclick="loadTable('announce')">ประกาศจัดซื้อจัดจ้าง</button>
            <button class="tab-btn" id="btn-winner" onclick="loadTable('winner')">ประกาศผู้ชนะการเสนอราคา</button>
        </div>

        <h3 id="table-header" style="color:var(--text-muted); margin-top:0;">รายการล่าสุด</h3>

        <div id="loading-indicator">
            <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>กำลังโหลดข้อมูล...
        </div>

        <div class="table-responsive" id="table-container">
            </div>
    </main>

    <footer>
        &copy; 2024 ส่วนอำนวยการ สำนักวิจัยและพัฒนาการป่าไม้
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const supabaseUrl = 'https://rxqfmhrxoepjdsmmnqhk.supabase.co';
        const supabaseKey = 'sb_publishable_lMMLp3mTrIiSm1Om-HdQxw_oOrHub8g';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const categories = {
            'plan': { 
                tableName: 'procurement_plan', 
                label: 'แผนการจัดซื้อจัดจ้าง',
                link: 'procurement_plan.html'
            },
            'draft': { 
                tableName: 'procurement_draft', 
                label: 'ประกาศร่างขอบเขตของงานและราคากลาง',
                link: 'procurement_draft.html'
            },
            'announce': { 
                tableName: 'procurement_announce', 
                label: 'ประกาศจัดซื้อจัดจ้าง',
                link: 'procurement_announce.html'
            },
            'winner': { 
                tableName: 'procurement_winner', 
                label: 'ประกาศผู้ชนะการเสนอราคา',
                link: 'procurement_winner.html'
            }
        };

        function formatThaiDate(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            const months = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543; 
            return `${day} ${month} ${year.toString().slice(-2)}`; 
        }

        function isNew(dateString) {
            if (!dateString) return false;
            const itemDate = new Date(dateString);
            const diffTime = Math.abs(new Date() - itemDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays <= 7;
        }

        window.loadTable = async function(categoryKey) {
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${categoryKey}`);
            if(activeBtn) activeBtn.classList.add('active');

            const config = categories[categoryKey];
            document.getElementById('table-header').innerText = config.label + " (ล่าสุด)";
            
            const container = document.getElementById('table-container');
            const loading = document.getElementById('loading-indicator');

            container.innerHTML = '';
            loading.style.display = 'block';

            try {
                // Fetch data, limited to 5 items
                const { data, error } = await supabase
                    .from(config.tableName)
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(5);

                loading.style.display = 'none';

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-data">ยังไม่มีข้อมูลในหมวดหมู่นี้</div>';
                    return;
                }

                let html = `
                    <table class="doc-table">
                        <thead>
                            <tr>
                                <th>เรื่อง</th>
                                <th>วันที่ประกาศ</th>
                                <th>ดาวน์โหลด</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(item => {
                    const title = item.description || item.title || 'ไม่มีชื่อเรื่อง';
                    const dateRaw = item.date || item.created_at;
                    
                    // ตรวจสอบและดึงข้อมูลลิ้งก์อย่างรัดกุม (เผื่อชื่อฟิลด์ผิดหรือไม่มีข้อมูล)
                    const rawFileLink = item.file_url || item.url || item.link || '';
                    // ตรวจสอบว่ามีข้อมูลลิ้งก์หรือไม่ และลิ้งก์ไม่ใช่ #
                    const hasFile = rawFileLink && rawFileLink.trim() !== '' && rawFileLink !== '#';

                    const badge = isNew(dateRaw) ? '<span class="new-badge">NEW</span>' : '';
                    
                    // กำหนดแอตทริบิวต์สำหรับปุ่ม
                    let btnHtml = '';
                    if (hasFile) {
                        btnHtml = `
                            <a href="${rawFileLink}" target="_blank" class="pdf-link">
                                <i class="fas fa-file-pdf"></i> ดาวน์โหลด
                            </a>
                        `;
                    } else {
                        // กรณีไม่มีไฟล์ ให้ปุ่มกดแล้วแจ้งเตือน หรือเปลี่ยนสีเป็นสีเทา
                        btnHtml = `
                            <a href="javascript:void(0)" onclick="alert('ไม่พบเอกสารแนบในระบบ');" class="pdf-link no-file">
                                <i class="fas fa-file-times"></i> ไม่มีไฟล์
                            </a>
                        `;
                    }
                    
                    html += `
                        <tr>
                            <td>${title} ${badge}</td>
                            <td>${formatThaiDate(dateRaw)}</td>
                            <td>
                                ${btnHtml}
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;

                html += `
                    <div class="view-all-container">
                        <a href="${config.link}" class="view-all-link">
                            อ่านทั้งหมด <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                `;

                container.innerHTML = html;

            } catch (err) {
                console.error('Error fetching data:', err);
                loading.style.display = 'none';
                container.innerHTML = `<div class="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${err.message}</div>`;
            }
        }

        // Initialize
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        
        if(tabParam && categories[tabParam]) {
            loadTable(tabParam);
        } else {
            loadTable('plan'); 
        }

        window.loadCategory = function(key) {
            document.querySelector('.content-container').scrollIntoView({ behavior: 'smooth' });
            loadTable(key);
        }
    </script>
</body>
</html>