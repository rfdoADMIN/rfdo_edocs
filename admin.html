<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="icon" type="image/png" href="images/logorfdo.png">

<style>
/* ‡∏™‡πÑ‡∏ï‡∏•‡πå CSS */
html, body, input, button { font-family: "Prompt", sans-serif !important; }
body { margin: 0; background: #f3f8f8; }
.admin-header { background: #339999; color: white; padding: 20px 30px; font-size: 24px; font-weight: 600; letter-spacing: 0.5px; text-align: center; }
.container { text-align: center; margin: 25px auto; max-width: 90%; }
.container a { background: #339999; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 500; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 0 5px 10px 5px; display: inline-block; transition: 0.3s; }
.container a:hover { background: #267373; }
table { 
    width: 90%; 
    margin: 20px auto; 
    border-collapse: collapse; 
    background: white; 
    border-radius: 10px; 
    overflow: hidden; 
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    table-layout: fixed; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà */
}
th, td { 
    border: 1px solid #ddd; 
    padding: 12px; 
    text-align: center; 
    vertical-align: top;
    word-wrap: break-word; /* ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
}

/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
th:nth-child(2), td:nth-child(2) { /* ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á */
    width: 30%;
    text-align: left;
}
th:nth-child(6), td:nth-child(6),
th:nth-child(7), td:nth-child(7) { /* ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö ‡πÅ‡∏•‡∏∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ */
    width: 80px;
}
th:nth-child(5), td:nth-child(5) { /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà */
    width: 100px;
}
th:nth-child(1), td:nth-child(1) { /* ID */
    width: 50px;
}

th { background: #339999; color: white; font-weight: 500; font-size: 16px; }
tr:nth-child(even) { background: #f6fbfb; }
tr:hover { background: #e0f3f3; transition: 0.2s; }
a.btn { padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 14px; margin: 0 3px; display: inline-block; transition: 0.2s; }
a.view { background: #2a8c8c; color: white; }
a.view:hover { background: #247a7a; }
a.delete { background: #cc4444; color: white; cursor: pointer; } 
a.delete:hover { background: #b23232; }

@media(max-width: 768px){
    table, th, td { font-size: 12px; }
    .admin-header { font-size: 20px; padding: 15px 20px; }
    .container a { padding: 8px 16px; font-size: 14px; }
    table { width: 98%; }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(3), td:nth-child(3) { /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        display: none;
    }
}
</style>
</head>
<body>

<div class="admin-header">üìÇ ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Document Admin Panel)</div>

<div class="container">
  <a href="uploads.html">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</a>
  <a href="index.html">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  <a href="https://app.supabase.com/project/rxfqfmhrxoejpdsmnqhk/editor" target="_blank">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Supabase Studio)</a>
</div>

<table id="adminTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
      <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
      <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody id="documentList">
    <tr><td colspan="7">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...</td></tr>
  </tbody>
</table>

<script type="module">
// *** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supabase ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ***
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'; 

const SUPABASE_URL = "https://rxfqfmhrxoejpdsmnqhk.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_1MMLp3mTRrIi5m1Om-HdQVW_0DrHub8g"; 

// ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Client ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Warning)
if (!window.supabaseClient) {
    window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
}

const supabase = window.supabaseClient; 
const documentList = document.getElementById('documentList');

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
async function loadDocuments() {
    documentList.innerHTML = '<tr><td colspan="7">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...</td></tr>';
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á documents
    const { data, error } = await supabase.from('documents').select('*').order('id', { ascending: true });

    if (error) {
        documentList.innerHTML = `<tr><td colspan="7">Error fetching data. (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Key ‡∏´‡∏£‡∏∑‡∏≠ RLS Policy): ${error.message}</td></tr>`;
        console.error("Supabase Error:", error);
        return;
    }

    if (!data || data.length === 0) {
        documentList.innerHTML = '<tr><td colspan="7">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
        return;
    }

    documentList.innerHTML = ''; 
    data.forEach(doc => {
        // ‡πÉ‡∏ä‡πâ doc.filename ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive
        let fileUrl = doc.filename; 

        // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Direct Download (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°)
        if (fileUrl && fileUrl.includes('drive.google.com')) {
            const fileIdMatch = fileUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (fileIdMatch && fileIdMatch[1]) {
                const fileId = fileIdMatch[1];
                // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                fileUrl = `https://drive.google.com/uc?export=download&id=${fileId}`; 
            }
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
        const formattedDate = doc.date ? new Date(doc.date).toLocaleDateString('th-TH', { 
            year: 'numeric', month: 'short', day: 'numeric' 
        }) : '-';
        
        const row = `
            <tr>
                <td>${doc.id}</td>
                <td>${doc.title}</td>
                <td>${doc.level || '-'}</td>
                <td>${doc.doc_number || '-'}</td>
                <td>${formattedDate}</td>
                <td><a class="btn view" href="${fileUrl}" target="_blank">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</a></td>
                <td><a class="btn delete" data-id="${doc.id}" href="#">‡∏•‡∏ö</a></td>
            </tr>
        `;
        documentList.innerHTML += row;
    });
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', handleDelete);
    });
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö
async function handleDelete(event) {
    event.preventDefault();
    const docId = event.target.getAttribute('data-id');
    
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID: ${docId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•? (‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)`)) {
        return;
    }
    
    // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å Database 
    const { error: dbError } = await supabase.from('documents').delete().eq('id', docId);

    if (dbError) {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${dbError.message}`);
        console.error("Delete Error:", dbError);
    } else {
        alert(`‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID: ${docId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        loadDocuments(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
    }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
window.onload = loadDocuments;
</script>

</body>
</html>
