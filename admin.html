<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>à¸«à¸™à¹‰à¸²à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š - à¸£à¸°à¸šà¸šà¹€à¸­à¸à¸ªà¸²à¸£</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="icon" type="image/png" href="images/logorfdo.png">
<script src="js/supabase.min.js"></script>

<style>
/* à¸ªà¹„à¸•à¸¥à¹Œ CSS */
html, body, input, button { font-family: "Prompt", sans-serif !important; }
body { margin: 0; background: #f3f8f8; }
.admin-header { background: #339999; color: white; padding: 20px 30px; font-size: 24px; font-weight: 600; letter-spacing: 0.5px; text-align: center; }
.container { text-align: center; margin: 25px auto; max-width: 90%; }
.container a { background: #339999; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 500; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 0 5px 10px 5px; display: inline-block; transition: 0.3s; }
.container a:hover { background: #267373; }
table { width: 90%; margin: auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
th { background: #339999; color: white; font-weight: 500; font-size: 16px; }
tr:nth-child(even) { background: #f6fbfb; }
tr:hover { background: #e0f3f3; transition: 0.2s; }
a.btn { padding: 6px 12px; border-radius: 8px; text-decoration: none; font-size: 14px; margin: 0 3px; display: inline-block; transition: 0.2s; }
a.view { background: #2a8c8c; color: white; }
a.view:hover { background: #247a7a; }
a.delete { background: #cc4444; color: white; cursor: pointer; } 
a.delete:hover { background: #b23232; }

@media(max-width: 768px){
Â  Â  table, th, td { font-size: 12px; }
Â  Â  .admin-header { font-size: 20px; padding: 15px 20px; }
Â  Â  .container a { padding: 8px 16px; font-size: 14px; }
Â  Â  table { width: 98%; }
}
</style>
</head>
<body>

<div class="admin-header">ğŸ“‚ à¸«à¸™à¹‰à¸²à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š (Document Admin Panel)</div>

<div class="container">
Â  <a href="uploads.html">â• à¹€à¸à¸´à¹ˆà¸¡à¹€à¸­à¸à¸ªà¸²à¸£à¹ƒà¸«à¸¡à¹ˆ</a>
Â  <a href="index.html">ğŸ  à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
Â  <a href="https://app.supabase.com/project/rxfqfmhrxoejpdsmnqhk/editor" target="_blank">âš™ï¸ à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Supabase Studio)</a>
</div>

<table id="adminTable">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th>ID</th>
Â  Â  Â  <th>à¸Šà¸·à¹ˆà¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡</th>
Â  Â  Â  <th>à¸£à¸°à¸”à¸±à¸š</th>
Â  Â  Â  <th>à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹€à¸­à¸à¸ªà¸²à¸£</th>
Â  Â  Â  <th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
Â  Â  Â  <th>à¹„à¸Ÿà¸¥à¹Œà¹à¸™à¸š</th>
Â  Â  Â  <th>à¸ˆà¸±à¸”à¸à¸²à¸£</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody id="documentList">
Â  Â  <tr><td colspan="7">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸­à¸à¸ªà¸²à¸£...</td></tr>
Â  </tbody>
</table>

<script>
// *** à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Supabase à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ ***
const SUPABASE_URL = "https://rxfqfmhrxoejpdsmnqhk.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_1MMLp3mTRrIi5m1Om-HdQVW_0DrHub8g"; 
// ğŸš¨ à¹à¸à¹‰à¹„à¸‚ ReferenceError/TypeError: à¹ƒà¸Šà¹‰ window.supabase.createClient
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const documentList = document.getElementById('documentList');

// 1. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸”à¸¶à¸‡à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸­à¸à¸ªà¸²à¸£
async function loadDocuments() {
Â  Â  documentList.innerHTML = '<tr><td colspan="7">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸­à¸à¸ªà¸²à¸£...</td></tr>';
Â  Â  
Â  Â  // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸²à¸à¸•à¸²à¸£à¸²à¸‡ documents
Â  Â  const { data, error } = await supabase.from('documents').select('*').order('id', { ascending: true });

Â  Â  if (error) {
Â  Â  Â  Â  documentList.innerHTML = `<tr><td colspan="7">Error fetching data. (à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š RLS Policy): ${error.message}</td></tr>`;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (!data || data.length === 0) {
Â  Â  Â  Â  documentList.innerHTML = '<tr><td colspan="7">à¹„à¸¡à¹ˆà¸à¸šà¹€à¸­à¸à¸ªà¸²à¸£à¹ƒà¸™à¸£à¸°à¸šà¸š</td></tr>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  documentList.innerHTML = ''; 
Â  Â  data.forEach(doc => {
Â  Â  Â  Â  // à¹ƒà¸Šà¹‰ doc.filename à¹€à¸›à¹‡à¸™à¸¥à¸´à¸‡à¸à¹Œ Google Drive
Â  Â  Â  Â  let fileUrl = doc.filename; 

Â  Â  Â  Â  // à¹‚à¸„à¹‰à¸”à¹€à¸ªà¸£à¸´à¸¡: à¸à¸¢à¸²à¸¢à¸²à¸¡à¹à¸›à¸¥à¸‡à¸¥à¸´à¸‡à¸à¹Œ Google Drive à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ Direct Download 
Â  Â  Â  Â  if (fileUrl && fileUrl.includes('drive.google.com/file/d/')) {
Â  Â  Â  Â  Â  Â  const fileIdMatch = fileUrl.match(/\/d\/([a-zA-Z0-9_-]+)\//);
Â  Â  Â  Â  Â  Â  if (fileIdMatch && fileIdMatch[1]) {
Â  Â  Â  Â  Â  Â  Â  Â  fileUrl = `https://drive.google.com/uc?export=download&id=${fileIdMatch[1]}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // à¹à¸›à¸¥à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸—à¸µà¹ˆà¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢
        const formattedDate = doc.date ? new Date(doc.date).toLocaleDateString('th-TH', { 
            year: 'numeric', month: 'short', day: 'numeric' 
        }) : '-';
        
Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${doc.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${doc.title}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${doc.level || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${doc.doc_number || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${formattedDate}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><a class="btn view" href="${fileUrl}" target="_blank">à¸”à¸¹à¹„à¸Ÿà¸¥à¹Œ</a></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><a class="btn delete" data-id="${doc.id}" data-filename="${doc.filename}" href="#">à¸¥à¸š</a></td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  Â  documentList.innerHTML += row;
Â  Â  });
Â  Â  
Â  Â  // à¸à¸³à¸«à¸™à¸” Event Listener à¸ªà¸³à¸«à¸£à¸±à¸šà¸›à¸¸à¹ˆà¸¡à¸¥à¸š
Â  Â  document.querySelectorAll('.delete').forEach(button => {
Â  Â  Â  Â  button.addEventListener('click', handleDelete);
Â  Â  });
}

// 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¸¥à¸š
async function handleDelete(event) {
Â  Â  event.preventDefault();
Â  Â  const docId = event.target.getAttribute('data-id');
Â  Â  
Â  Â  if (!confirm(`à¸„à¸¸à¸“à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸—à¸µà¹ˆà¸ˆà¸°à¸¥à¸šà¹€à¸­à¸à¸ªà¸²à¸£ ID: ${docId} à¸­à¸­à¸à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥? (à¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸¢à¸™à¸­à¸à¸ˆà¸°à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸¥à¸š)`)) {
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ˆà¸²à¸ Database 
Â  Â  const { error: dbError } = await supabase.from('documents').delete().eq('id', docId);

Â  Â  if (dbError) {
Â  Â  Â  Â  alert(`à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: ${dbError.message}`);
Â  Â  } else {
Â  Â  Â  Â  alert(`à¸¥à¸šà¹€à¸­à¸à¸ªà¸²à¸£ ID: ${docId} à¸­à¸­à¸à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§`);
Â  Â  Â  Â  loadDocuments(); 
Â  Â  }
}

// à¹€à¸£à¸´à¹ˆà¸¡à¹‚à¸«à¸¥à¸”à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸¡à¸·à¹ˆà¸­à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆ
window.onload = loadDocuments;
</script>

</body>

</html>
